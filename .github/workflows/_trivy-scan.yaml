---
# yaml-language-server: $schema=https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/github-workflow.json
name: Trivy Vulnerability Scan Template

on:
  workflow_call:
    inputs:
      trivy-config:
        description: "Path to Trivy config file"
        type: string
        required: false
        default: "trivy.yaml"
      scan-type:
        description: "Trivy scan type (fs, repo, image, etc.)"
        type: string
        required: false
        default: "fs"

permissions:
  contents: read
  issues: write

jobs:
  scan:
    name: Scan for vulnerabilities
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac
        with:
          scan-type: ${{ inputs.scan-type }}
          trivy-config: ${{ inputs.trivy-config }}
          format: json
          output: trivy-results.json
          ignore-unfixed: false
          exit-code: 0

      - name: Process results and manage issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # shellcheck disable=SC2016
        run: |
          ISSUE_TITLE="[Trivy] Security vulnerabilities found"

          if [ ! -f trivy-results.json ]; then
            echo "No Trivy results file found"
            exit 0
          fi

          ALL_VULNS=$(jq -r '
            [.Results[]? | .Vulnerabilities[]? | {
              id: .VulnerabilityID,
              severity: .Severity,
              package: .PkgName,
              installed: .InstalledVersion,
              fixed: (.FixedVersion // "unfixed")
            }] | unique_by(.id)
          ' trivy-results.json)

          TOTAL_VULN_COUNT=$(echo "$ALL_VULNS" | jq 'length')
          CRITICAL=$(echo "$ALL_VULNS" | jq '[.[] | select(.severity == "CRITICAL")] | length')
          HIGH=$(echo "$ALL_VULNS" | jq '[.[] | select(.severity == "HIGH")] | length')
          MEDIUM=$(echo "$ALL_VULNS" | jq '[.[] | select(.severity == "MEDIUM")] | length')

          echo "Found $TOTAL_VULN_COUNT total vulnerabilities ($CRITICAL CRITICAL, $HIGH HIGH, $MEDIUM MEDIUM)"

          EXISTING=$(gh issue list --state open --json number,title | \
            jq --arg title "$ISSUE_TITLE" -r '.[] | select(.title == $title) | .number' | \
            head -1)

          SCAN_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")

          if [ "$TOTAL_VULN_COUNT" -eq 0 ]; then
            echo "No vulnerabilities found"
            if [ -n "$EXISTING" ]; then
              gh issue close "$EXISTING" \
                --comment "All vulnerabilities resolved as of $SCAN_DATE."
              echo "Closed issue #$EXISTING"
            fi
            exit 0
          fi

          CRITICAL_HIGH_VULNS=$(echo "$ALL_VULNS" | jq -r '[.[] | select(.severity == "CRITICAL" or .severity == "HIGH")]')
          ACTIONABLE_COUNT=$(echo "$CRITICAL_HIGH_VULNS" | jq 'length')

          VULN_TABLE=$(echo "$CRITICAL_HIGH_VULNS" | jq -r '
            .[] | "| \(.id) | \(.severity) | \(.package) | \(.installed) | \(.fixed) |"
          ')

          BODY=$(cat <<EOF
          ## Vulnerability Scan Results

          **Scan Date:** $SCAN_DATE
          **Total:** $TOTAL_VULN_COUNT vulnerabilities ($CRITICAL CRITICAL, $HIGH HIGH, $MEDIUM MEDIUM)

          $(if [ "$ACTIONABLE_COUNT" -gt 0 ]; then
            cat <<TABLE

          ### CRITICAL and HIGH Vulnerabilities

          | CVE | Severity | Package | Installed | Fixed |
          |-----|----------|---------|-----------|-------|
          $VULN_TABLE
          TABLE
            if [ "$MEDIUM" -gt 0 ]; then
              echo ""
              echo "**Note:** $MEDIUM MEDIUM severity vulnerabilities not shown in table. [View full scan results]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)."
            fi
          fi)$(if [ "$ACTIONABLE_COUNT" -eq 0 ] && [ "$MEDIUM" -gt 0 ]; then
            cat <<MEDIUMONLY

          ### Summary

          Only MEDIUM severity vulnerabilities detected. [View full scan results]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID) for details.
          MEDIUMONLY
          fi)

          ---
          *This issue is auto-generated by the Trivy scan workflow.*
          EOF
          )

          LABELS="security,trivy"
          [ "$CRITICAL" -gt 0 ] && LABELS="$LABELS,critical"
          [ "$HIGH" -gt 0 ] && LABELS="$LABELS,high"
          [ "$MEDIUM" -gt 0 ] && LABELS="$LABELS,medium"

          for label in $(echo "$LABELS" | tr ',' ' '); do
            if ! gh label list --json name -q ".[].name" | grep -qx "$label"; then
              case "$label" in
                security) gh label create "$label" --color "d73a4a" --description "Security vulnerability" ;;
                trivy)    gh label create "$label" --color "0052cc" --description "Trivy scan finding" ;;
                critical) gh label create "$label" --color "b60205" --description "Critical severity" ;;
                high)     gh label create "$label" --color "d93f0b" --description "High severity" ;;
                medium)   gh label create "$label" --color "fbca04" --description "Medium severity" ;;
              esac
            fi
          done

          if [ -n "$EXISTING" ]; then
            EXISTING_SEVERITY=$(gh issue view "$EXISTING" --json labels -q '.labels[].name' | grep -E '^(critical|high|medium)$' | paste -sd, || echo "")
            [ -n "$EXISTING_SEVERITY" ] && gh issue edit "$EXISTING" --remove-label "$EXISTING_SEVERITY"
            gh issue edit "$EXISTING" --body "$BODY" --add-label "$LABELS"
            echo "Updated issue #$EXISTING"
          else
            gh issue create --title "$ISSUE_TITLE" --body "$BODY" --label "$LABELS"
            echo "Created new issue"
          fi
