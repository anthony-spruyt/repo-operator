---
# yaml-language-server: $schema=https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/github-workflow.json
name: Security Scan (Reusable)

on:
  workflow_call:
    inputs:
      trivy-config:
        description: "Path to Trivy config file"
        type: string
        required: false
        default: "trivy.yaml"
      scan-type:
        description: "Trivy scan type (fs, repo, image, etc.)"
        type: string
        required: false
        default: "fs"
      severity:
        description: "Severity levels to report"
        type: string
        required: false
        default: "CRITICAL,HIGH"
      ignore-unfixed:
        description: "Ignore unfixed vulnerabilities"
        type: boolean
        required: false
        default: false

jobs:
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-security-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98
        with:
          fetch-depth: 0

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac
        with:
          scan-type: ${{ inputs.scan-type }}
          scan-ref: "."
          trivy-config: ${{ inputs.trivy-config }}
          severity: ${{ inputs.severity }}
          ignore-unfixed: ${{ inputs.ignore-unfixed }}
          exit-code: "1"
          format: "table"
