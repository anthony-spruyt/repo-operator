---
# yaml-language-server: $schema=https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/github-workflow.json
name: CI Summary

on:
  workflow_call:

jobs:
  summary:
    name: Check Results
    runs-on: ubuntu-latest
    steps:
      - name: Check job results
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Fetch all jobs in this workflow run (exclude this summary job)
          jobs_json=$(gh api "repos/$REPO/actions/runs/$RUN_ID/jobs" \
            --jq '[.jobs[] | select(.name != "summary / Check Results") | {name: .name, conclusion: .conclusion}]')

          # Build summary table
          echo "## CI Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Job | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----|--------|" >> "$GITHUB_STEP_SUMMARY"

          echo "$jobs_json" | jq -r '.[] | "\(.name)|\(.conclusion)"' | while IFS='|' read -r name conclusion; do
            case "$conclusion" in
              success)   icon="✅" ;;
              failure)   icon="❌" ;;
              cancelled) icon="⚪" ;;
              skipped)   icon="⏭️" ;;
              *)         icon="❓" ;;
            esac
            echo "| $name | $icon ${conclusion:-pending} |" >> "$GITHUB_STEP_SUMMARY"
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Check for failures
          if echo "$jobs_json" | jq -e '.[] | select(.conclusion == "failure" or .conclusion == "cancelled")' > /dev/null 2>&1; then
            echo "::error::One or more jobs failed or were cancelled"
            exit 1
          fi

          echo "::notice::All jobs passed"
